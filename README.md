# vdock

Your remote docker development environment.

## Concept

Use remote servers to host a Docker daemon, and control it from your local machine. This way you can build and run resource-heavy containers using minimal resources on your local machine.

## Requirements

- Docker client (no virtual machine required, or Docker Desktop required)
- [Mutagen.io](https://mutagen.io/) client (optional, recommended).
- Server running vdock.

## Installation

1) Add docker host to your known hosts.
```
ssh-keyscan -H your-name.docker-host.dev >> ~/.ssh/known_hosts
```

Alternative:
Connect to a host for the first time using `ssh vdock@your-name.docker-host.dev`.

2) Set `DOCKER_HOST` env variable.
You can set it up one-time per session using `export DOCKER_HOST=ssh://vdock@your-name.docker-host.dev` or set it permanently in `~/.zshenv` (zsh) or `~/.bashrc` (bash). When `DOCKER_HOST` is set, your docker client will use it in all docker commands.

## Usage

### Files sync

If you are using volumes in your docker files, you will need to synchronize your local files with the remote server before running Docker container.

If you keep your files in `/Users/John/Code/my-project` you would need to run:

```
mutagen sync create /Users/John/Code/my-project vdock@your-name.docker-host.dev:/vdock/my-project
```

If you running web project using nginx it might be good idea to set default file permissions:
```
mutagen sync create /Users/John/Code/my-project vdock@your-name.docker-host.dev:/vdock/my-project  --default-file-mode=0664 --default-directory-mode=0775 --default-group-beta=www-data
```

Initial sync might take some time. You can run `mutagen list` to check sync status. Wait until status becomes `Watching for changes` before using `docker-compose up`. 

You will also need to update your `docker-compose.yml` and replace `./` or local path, to `/vdock/my-project`, for example;
```
    volumes:
      - "./:/var/www/app"
```
should become
```
    volumes:
      - "/vdock/my-project:/vdock/my-project"
```
### Virtual host

Pass VIRTUAL_HOST environment variable to your docker instance and use any domain in `*.virtual-host.dev`.

Example:
```
    environment:
      - VIRTUAL_HOST=my-dev-host.virtual-host.dev
```

SSL certificate is automatically generated by vdock proxy. Remember domain is publicly accessible and can be used by anyone. It's recommended to use unique hostnames like `app-name-dev-name.virtual-host.dev` or even `app-name-randomstring.virtual-host.dev`. Behind the scenes, vdock is using [Dinghy HTTP Proxy](https://github.com/codekitchen/dinghy-http-proxy).


### Docker commands

If your `DOCKER_HOST` is set and files are in sync you can use regular `docker-compose up`, otherwise you can pass -H parameter to your docker commands, for example, `docker-compose -H ssh://vdock@your-name.docker-host.dev up`. You can also use [mutagen.io](https://mutagen.io/documentation/forwarding) for network forwarding.

## Known issues

- Keeping your dev environment public might be risky. It's recommended to not display publicly your database ports, and use unique VIRTUAL_HOST names.
- Keeping the files permissions in sync might be problematic. When file is created from the container, it will be owned by a root account, and updated from your local will cause `permission denied` error. To fix this issue you can run chown -R 1000 inside your container.
- HTTP proxy is currently set to use HTTP so your traffic from `https://my-dev-host.virtual-host.dev` will be forwarded to `http://your-name.docker-host.dev` which will use your containers [first exposed port](https://github.com/codekitchen/dinghy-http-proxy#exposed-ports).
